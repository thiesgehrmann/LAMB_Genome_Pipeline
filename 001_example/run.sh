#!/usr/bin/env bash
# LAMB Genome Pipeline script

#####################################################################################################################################################
#####################################################################################################################################################
################################ DO NOT TOUCH #######################################################################################################
#####################################################################################################################################################
#####################################################################################################################################################
                                                                                                                                                    #
# Boilerplate initialize code                                                                                                                       #
LGPS_DIR=`realpath "$( cd -- "$( dirname -- "${BASH_SOURCE[0]:-$0}"; )" &> /dev/null && pwd 2> /dev/null; )"`;                                      #
LGP_DIR=`realpath "$LGPS_DIR/../"`                                                                                                                  #
for lgpc in `ls "$LGP_DIR/00_common/" | grep '[.]sh$' `; do                                                                                         #
    source "$LGP_DIR/00_common/$lgpc";                                                                                                             #
done                                                                                                                                                #
LGPS_name=`basename "$LGPS_DIR"`;                                                                                                                   #
LGPS_version=`LGP_version "$LGPS_DIR/$0"`                                                                                                           #
command="$0 $@";                                                                                                                                    #
zero="$0";                                                                                                                                          #
longformopts="noconda,force,outdir:";                                                                                                               #
noconda=0;                                                                                                                                          #
force=0                                                                                                                                             #
                                                                                                                                                    #
#####################################################################################################################################################

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++ MODIFY HERE +++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#

# Define the usage function
function usage(){
    echo "LAMB Genome Pipeline ($LGPS_name)"
    echo "Version: $LGPS_version"
    echo "Usage: $zero [options] <GENOMENAME> <file1> <file2> <file3>"
    echo "  Options:"
    echo "    -t|--threads  : Number of threads to use (default 1)"
    ################## DO NOT TOUCH #########################################################################
    echo "    --noconda:    : Do not use conda"                                                             #
    echo "    --force       : Do not give opportunity to cancel run if previous directory exists"           #
    echo "    --outdir      : Use this location instead of the standard LGP output (default $LGP_outdir)"   #
    echo "  Inputs:"                                                                                        #
    echo "    GENOMENAME : The name of this genome (e.g. AMBV666)"                                          #
    #########################################################################################################
    echo "    file1 : File path to file1."
    echo "    file2 : File path to file2."
    echo "    file3 : File path to file3."
}

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
# Process options and inputs

ARGS=$(getopt -o 't:' --long "${longformopts},threads:" -- "$@") || exit
eval "set -- $ARGS"

threads=1

nparams=3 # The number of parameters following you require (if not specified, set to -1)

while true; do
    case $1 in
        ############### DO NOT TOUCH########################################
        (--noconda)                                                        #
            noconda=1; shift 1;;                                           #
        (--force)                                                          #
            force=1; shift 1;;                                             #
        (--outdir)                                                         #
            export LGP_outdir=`realpath -m "$2"`; shift 2;;                #
        ####################################################################
        (-t|--threads)
            threads=$2; shift 2;;
        (--)  shift; break;;
        (*)   usage; exit 1;;           # error
    esac
done

#####################################################################################################################################################
#####################################################################################################################################################
################################ DO NOT TOUCH #######################################################################################################
#####################################################################################################################################################
#####################################################################################################################################################
                                                                                                                                                    #
# Deal with file inputs                                                                                                                             #
                                                                                                                                                    #
remaining=("$@") # Get the rest of the parmeters that are not options                                                                               #
                                                                                                                                                    #
if [ ! "$nparams" -eq -1 ]; then                                                                                                                    #
    if [ ! "${#remaining[@]}" -eq $((nparams+1)) ]; then                                                                                            #
        usage                                                                                                                                       #
        exit 1                                                                                                                                      #
    fi                                                                                                                                              #
fi                                                                                                                                                  #
                                                                                                                                                    #
genomename=${remaining[0]}                                                                                                                          #
                                                                                                                                                    #
#####################################################################################################################################################

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++ MODIFY HERE +++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#

file1=`realpath -m "${remaining[1]}"`
file2=`realpath -m "${remaining[2]}"`
file3=`realpath -m "${remaining[3]}"`

# Verify that the input files exist
LGP_existsorfail "$file1" 1
LGP_existsorfail "$file2" 1
LGP_existsorfail "$file3" 1

#####################################################################################################################################################
#####################################################################################################################################################
################################ DO NOT TOUCH #######################################################################################################
#####################################################################################################################################################
#####################################################################################################################################################
                                                                                                                                                    #
# Initialize the output folder                                                                                                                      #
path=`LGP_init "$LGP_outdir" "$genomename" "$LGPS_name" "$LGPS_version" "$force" "$command"`                                                        #
                                                                                                                                                    #
# Load conda environment (if necessary)                                                                                                             #
if [ "$noconda" -eq 0 ]; then                                                                                                                       #
    LGP_conda "mda" "$LGPS_DIR/conda.yml" # Use an existing conda environment for testing                                                           #
    #LGP_conda "LGPS_${LGPS_name}" "$LGPS_DIR/conda.yml" # Use this when ready                                                                      #
fi                                                                                                                                                  #
                                                                                                                                                    #
#####################################################################################################################################################

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++ MODIFY HERE +++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
# Program code


# Perform the operations
cp "$file1" "$path/file1"
status1="$?" # KEEP THE RETURN VALUE OF THE ANALYSIS

cp "$file2" "$path/file2"
status2="$?"

cp "$file3" "$path/file3"
status3="$?"

for i in `seq 20`; do
    wrn=`LGP_message "COUNTDOWN" 2>&1`
    echo -en "\r$wrn ($((20-i)))..." >&2
    sleep 1
    if [ ! $? -eq 0 ] ; then # Make sure we catch an escape!
        exit 2
    fi
done
echo ""

status=$((status1 + status2 + status3))


#####################################################################################################################################################
#####################################################################################################################################################
################################ DO NOT TOUCH #######################################################################################################
#####################################################################################################################################################
#####################################################################################################################################################
                                                                                                                                                    #
# Wrap up                                                                                                                                           #
if [ "$status" -eq 0 ]; then                                                                                                                        #
    LGP_complete "$path"                                                                                                                            #
else                                                                                                                                                #
    LGP_fail "$path"                                                                                                                                #
fi                                                                                                                                                  #
                                                                                                                                                    #
#####################################################################################################################################################